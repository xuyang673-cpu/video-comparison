<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘å¯¹æ¯”å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .upload-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .file-input-label:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        input[type="file"] {
            display: none;
        }

        .file-name {
            color: #495057;
            font-size: 14px;
        }

        .video-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
            justify-items: center;
            align-items: start;
        }

        /* åªåœ¨éå¸¸å°çš„å±å¹•ä¸Šï¼ˆå°äº850pxï¼‰æ‰æ”¹ä¸ºä¸Šä¸‹å¸ƒå±€ */
        @media (max-width: 850px) {
            .video-section {
                grid-template-columns: 1fr;
            }
            .video-container {
                max-width: 100%;
            }
        }

        .video-container {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            max-width: 380px;
            max-height: 580px;
            margin: 0 auto;
            width: 100%;
        }

        .video-label {
            background: #343a40;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .video-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            min-height: 0;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 530px;
            object-fit: contain;
            display: block;
            background: #000;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .current-row-info {
            margin-left: auto;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            padding: 0 10px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .info-card label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }

        .info-card .url {
            color: #667eea;
            word-break: break-all;
            font-size: 12px;
        }

        .notes-section {
            margin-bottom: 20px;
        }

        .notes-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .difference-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .difference-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .difference-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .difference-option label {
            cursor: pointer;
            font-size: 14px;
            color: #495057;
        }


        .export-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
            text-align: center;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ è§†é¢‘å¯¹æ¯”å·¥å…·</h1>
            <p>åŒæ­¥æ’­æ”¾ä¸¤ä¸ªè§†é¢‘ï¼Œè¯†åˆ«å·®å¼‚å¹¶è®°å½•å¤‡æ³¨</p>
        </div>

        <div class="upload-section">
            <div class="file-input-wrapper">
                <label for="excelFile" class="file-input-label">ğŸ“ é€‰æ‹©Excelæ–‡ä»¶</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls">
                <span class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
                <button class="btn-secondary" id="clearSavedBtn" onclick="clearSavedData()" style="display:none; margin-left: 10px;">ğŸ—‘ï¸ æ¸…é™¤ä¿å­˜çš„æ•°æ®</button>
            </div>
            <div id="statusMessage"></div>
        </div>

        <div class="video-section">
            <div class="video-container">
                <div class="video-label" id="video1Label">è§†é¢‘ 1</div>
                <div class="video-wrapper">
                    <video id="video1" controls></video>
                </div>
            </div>
            <div class="video-container">
                <div class="video-label" id="video2Label">è§†é¢‘ 2</div>
                <div class="video-wrapper">
                    <video id="video2" controls></video>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="info-section">
                <div class="info-card">
                    <label>è§†é¢‘ 1 URL:</label>
                    <div class="url" id="url1">-</div>
                </div>
                <div class="info-card">
                    <label>è§†é¢‘ 2 URL:</label>
                    <div class="url" id="url2">-</div>
                </div>
            </div>

            <div class="control-buttons">
                <button class="btn-primary" id="playBtn" onclick="syncPlay()">â–¶ï¸ åŒæ­¥æ’­æ”¾</button>
                <button class="btn-primary" id="pauseBtn" onclick="syncPause()">â¸ï¸ åŒæ­¥æš‚åœ</button>
                <button class="btn-secondary" onclick="syncSeek(0)">â®ï¸ é‡ç½®</button>
                <button class="btn-secondary" id="prevBtn" onclick="previousRow()" disabled>â¬…ï¸ ä¸Šä¸€è¡Œ</button>
                <button class="btn-secondary" id="nextBtn" onclick="nextRow()" disabled>ä¸‹ä¸€è¡Œ â¡ï¸</button>
                <div class="current-row-info">
                    <span id="currentRowInfo">è¯·å…ˆåŠ è½½Excelæ–‡ä»¶</span>
                </div>
            </div>

            <div class="difference-section">
                <div class="difference-option">
                    <input type="radio" id="noDiff" name="difference" value="åŒè´¨åŒ–">
                    <label for="noDiff">åŒè´¨åŒ–</label>
                </div>
                <div class="difference-option">
                    <input type="radio" id="hasDiff" name="difference" value="éåŒè´¨åŒ–">
                    <label for="hasDiff">éåŒè´¨åŒ–</label>
                </div>
                <div class="difference-option">
                    <input type="radio" id="unknown" name="difference" value="æœªç¡®å®š">
                    <label for="unknown">æœªç¡®å®š</label>
                </div>
            </div>

            <div class="notes-section">
                <label for="notes">å¤‡æ³¨:</label>
                <textarea id="notes" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
            </div>
        </div>


        <div class="export-section">
            <button class="btn-success" id="exportBtn" onclick="exportToExcel()" disabled>ğŸ“¥ å¯¼å‡ºä¸ºExcel</button>
        </div>
    </div>

    <script>
        let videoData = [];
        let currentIndex = 0;
        let savedData = {};

        const video1 = document.getElementById('video1');
        const video2 = document.getElementById('video2');
        const excelFileInput = document.getElementById('excelFile');
        const fileNameSpan = document.getElementById('fileName');
        const statusMessage = document.getElementById('statusMessage');

        // è¾…åŠ©å‡½æ•°ï¼šè§„èŒƒåŒ–åˆ—åï¼ˆå»é™¤ç©ºæ ¼ã€ä¸‹åˆ’çº¿ï¼Œè½¬å°å†™ï¼‰
        function normalizeColumnName(name) {
            if (!name) return '';
            return name.toString().replace(/[\s_]/g, '').toLowerCase();
        }

        // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾åŒ¹é…çš„åˆ—å
        function findColumn(jsonData, patterns) {
            if (jsonData.length === 0) return null;
            
            const allKeys = Object.keys(jsonData[0]);
            for (const pattern of patterns) {
                const normalizedPattern = normalizeColumnName(pattern);
                for (const key of allKeys) {
                    if (normalizeColumnName(key) === normalizedPattern) {
                        return key;
                    }
                }
            }
            return null;
        }

        // å¤„ç†Excelæ•°æ®å¹¶åŠ è½½
        function processExcelData(jsonData, fileName) {
            if (jsonData.length === 0) {
                showStatus('Excelæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®', 'error');
                return false;
            }

            // æ˜¾ç¤ºæ‰€æœ‰åˆ—åç”¨äºè°ƒè¯•
            const allColumns = Object.keys(jsonData[0]);
            console.log('Excelæ–‡ä»¶ä¸­çš„æ‰€æœ‰åˆ—å:', allColumns);

            // æŸ¥æ‰¾è§†é¢‘URLåˆ—ï¼ˆæ”¯æŒå¤šç§å¯èƒ½çš„åˆ—åï¼‰
            const url1Column = findColumn(jsonData, [
                'material_url',
                'materialurl',
                'material url',
                'è§†é¢‘1',
                'video1',
                'url1'
            ]);

            const url2Column = findColumn(jsonData, [
                'milvus_material_url',
                'milvusmaterialurl',
                'milvus material url',
                'è§†é¢‘2',
                'video2',
                'url2'
            ]);

            if (!url1Column || !url2Column) {
                const missing = [];
                if (!url1Column) missing.push('ç¬¬ä¸€ä¸ªè§†é¢‘URLåˆ—');
                if (!url2Column) missing.push('ç¬¬äºŒä¸ªè§†é¢‘URLåˆ—');
                
                let errorMsg = `æœªæ‰¾åˆ°ä»¥ä¸‹åˆ—: ${missing.join(', ')}ã€‚\n`;
                errorMsg += `Excelæ–‡ä»¶ä¸­çš„åˆ—å: ${allColumns.join(', ')}\n`;
                errorMsg += `è¯·ç¡®ä¿Excelæ–‡ä»¶åŒ…å« material_url å’Œ milvus_material_url åˆ—ï¼ˆæˆ–ç±»ä¼¼çš„åˆ—åï¼‰`;
                showStatus(errorMsg, 'error');
                console.error('æ‰€æœ‰åˆ—å:', allColumns);
                return false;
            }

            // å­˜å‚¨åˆ—åä¾›åç»­ä½¿ç”¨
            window.url1ColumnName = url1Column;
            window.url2ColumnName = url2Column;

            // è¿‡æ»¤æœ‰æ•ˆæ•°æ®
            videoData = jsonData.filter(row => {
                const url1 = row[url1Column];
                const url2 = row[url2Column];
                return url1 && url2 && url1.toString().trim() && url2.toString().trim();
            });

            if (videoData.length === 0) {
                showStatus('Excelæ–‡ä»¶ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„è§†é¢‘é“¾æ¥', 'error');
                return false;
            }

            // ä¿å­˜åˆ°localStorage
            try {
                const dataToSave = {
                    videoData: videoData,
                    url1Column: url1Column,
                    url2Column: url2Column,
                    fileName: fileName || 'å·²ä¿å­˜çš„æ–‡ä»¶',
                    savedData: savedData || {},
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('videoComparisonData', JSON.stringify(dataToSave));
                console.log('æ•°æ®å·²ä¿å­˜åˆ°localStorage');
            } catch (error) {
                console.warn('ä¿å­˜åˆ°localStorageå¤±è´¥:', error);
            }

            // æ›´æ–°è§†é¢‘æ ‡ç­¾æ˜¾ç¤ºåˆ—å
            document.getElementById('video1Label').textContent = `è§†é¢‘ 1 (${url1Column})`;
            document.getElementById('video2Label').textContent = `è§†é¢‘ 2 (${url2Column})`;

            fileNameSpan.textContent = fileName || 'å·²åŠ è½½çš„æ–‡ä»¶';
            showStatus(`æˆåŠŸåŠ è½½ ${videoData.length} è¡Œæ•°æ® (åˆ—1: ${url1Column}, åˆ—2: ${url2Column})`, 'success');
            currentIndex = 0;
            loadRow(currentIndex);
            updateNavigationButtons();
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('clearSavedBtn').style.display = 'inline-block';
            
            return true;
        }

        // ä»localStorageåŠ è½½æ•°æ®
        function loadSavedData() {
            try {
                const saved = localStorage.getItem('videoComparisonData');
                if (saved) {
                    const data = JSON.parse(saved);
                    videoData = data.videoData || [];
                    window.url1ColumnName = data.url1Column;
                    window.url2ColumnName = data.url2Column;
                    savedData = data.savedData || {};
                    
                    if (videoData.length > 0) {
                        fileNameSpan.textContent = data.fileName || 'å·²ä¿å­˜çš„æ–‡ä»¶';
                        document.getElementById('video1Label').textContent = `è§†é¢‘ 1 (${data.url1Column})`;
                        document.getElementById('video2Label').textContent = `è§†é¢‘ 2 (${data.url2Column})`;
                        
                        currentIndex = 0;
                        loadRow(currentIndex);
                        updateNavigationButtons();
                        document.getElementById('exportBtn').disabled = false;
                        document.getElementById('clearSavedBtn').style.display = 'inline-block';
                        
                        showStatus(`å·²è‡ªåŠ¨åŠ è½½ä¿å­˜çš„æ•°æ®ï¼š${videoData.length} è¡Œï¼Œå·²æ ‡è®° ${Object.keys(savedData).length} è¡Œ`, 'success');
                        setTimeout(() => {
                            statusMessage.innerHTML = '';
                        }, 3000);
                        return true;
                    }
                }
            } catch (error) {
                console.error('ä»localStorageåŠ è½½æ•°æ®å¤±è´¥:', error);
            }
            return false;
        }

        // æ¸…é™¤ä¿å­˜çš„æ•°æ®
        function clearSavedData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤Excelæ•°æ®å’Œæ‰€æœ‰æ ‡è®°è®°å½•ã€‚')) {
                localStorage.removeItem('videoComparisonData');
                videoData = [];
                savedData = {};
                currentIndex = 0;
                fileNameSpan.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                document.getElementById('url1').textContent = '-';
                document.getElementById('url2').textContent = '-';
                document.getElementById('video1Label').textContent = 'è§†é¢‘ 1';
                document.getElementById('video2Label').textContent = 'è§†é¢‘ 2';
                document.getElementById('notes').value = '';
                document.querySelectorAll('input[name="difference"]').forEach(radio => {
                    radio.checked = false;
                });
                video1.src = '';
                video2.src = '';
                document.getElementById('exportBtn').disabled = true;
                document.getElementById('prevBtn').disabled = true;
                document.getElementById('nextBtn').disabled = true;
                document.getElementById('clearSavedBtn').style.display = 'none';
                document.getElementById('currentRowInfo').textContent = 'è¯·å…ˆåŠ è½½Excelæ–‡ä»¶';
                showStatus('å·²æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„æ•°æ®', 'info');
                setTimeout(() => {
                    statusMessage.innerHTML = '';
                }, 2000);
            }
        }

        // ä¿å­˜å½“å‰æ ‡è®°æ•°æ®åˆ°localStorage
        function saveToLocalStorage() {
            if (videoData.length > 0) {
                try {
                    const dataToSave = {
                        videoData: videoData,
                        url1Column: window.url1ColumnName,
                        url2Column: window.url2ColumnName,
                        fileName: fileNameSpan.textContent || 'å·²ä¿å­˜çš„æ–‡ä»¶',
                        savedData: savedData,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('videoComparisonData', JSON.stringify(dataToSave));
                } catch (error) {
                    console.warn('ä¿å­˜åˆ°localStorageå¤±è´¥:', error);
                }
            }
        }

        // è¯»å–Excelæ–‡ä»¶
        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            showStatus('æ­£åœ¨è¯»å–Excelæ–‡ä»¶...', 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    // é‡ç½®ä¿å­˜çš„æ ‡è®°æ•°æ®
                    savedData = {};
                    
                    if (processExcelData(jsonData, file.name)) {
                        // æ•°æ®åŠ è½½æˆåŠŸï¼Œå·²è‡ªåŠ¨ä¿å­˜åˆ°localStorage
                    }
                } catch (error) {
                    showStatus('è¯»å–Excelæ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                    console.error('é”™è¯¯è¯¦æƒ…:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // åŠ è½½æŒ‡å®šè¡Œçš„æ•°æ®
        function loadRow(index) {
            if (index < 0 || index >= videoData.length) return;

            const row = videoData[index];
            const url1Column = window.url1ColumnName || 'material_url';
            const url2Column = window.url2ColumnName || 'milvus_material_url';
            
            const url1 = row[url1Column];
            const url2 = row[url2Column];

            document.getElementById('url1').textContent = url1 || '-';
            document.getElementById('url2').textContent = url2 || '-';

            // åŠ è½½è§†é¢‘
            if (url1) {
                video1.src = url1.toString().trim();
            }
            if (url2) {
                video2.src = url2.toString().trim();
            }

            // æ¢å¤ä¿å­˜çš„æ•°æ®
            const saved = savedData[index];
            if (saved) {
                document.getElementById('notes').value = saved.notes || '';
                // æ¸…é™¤æ‰€æœ‰å•é€‰æŒ‰é’®
                document.querySelectorAll('input[name="difference"]').forEach(radio => {
                    radio.checked = false;
                });
                // è®¾ç½®ä¿å­˜çš„é€‰é¡¹
                if (saved.difference) {
                    const radio = document.querySelector(`input[value="${saved.difference}"]`);
                    if (radio) {
                        radio.checked = true;
                    }
                }
            } else {
                document.getElementById('notes').value = '';
                document.querySelectorAll('input[name="difference"]').forEach(radio => {
                    radio.checked = false;
                });
            }

            updateCurrentRowInfo();
        }

        // åŒæ­¥æ’­æ”¾
        function syncPlay() {
            const playPromise1 = video1.play();
            const playPromise2 = video2.play();

            Promise.all([playPromise1, playPromise2]).catch(error => {
                console.error('æ’­æ”¾é”™è¯¯:', error);
                showStatus('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥è§†é¢‘é“¾æ¥æ˜¯å¦æœ‰æ•ˆ', 'error');
            });
        }

        // åŒæ­¥æš‚åœ
        function syncPause() {
            video1.pause();
            video2.pause();
        }

        // åŒæ­¥è·³è½¬
        function syncSeek(time) {
            video1.currentTime = time;
            video2.currentTime = time;
        }

        // åŒæ­¥è§†é¢‘æ’­æ”¾è¿›åº¦
        video1.addEventListener('play', () => {
            if (video2.paused) {
                video2.play().catch(() => {});
            }
        });

        video2.addEventListener('play', () => {
            if (video1.paused) {
                video1.play().catch(() => {});
            }
        });

        video1.addEventListener('pause', () => {
            if (!video2.paused) {
                video2.pause();
            }
        });

        video2.addEventListener('pause', () => {
            if (!video1.paused) {
                video1.pause();
            }
        });

        // åŒæ­¥æ’­æ”¾è¿›åº¦
        let isSyncing = false;
        video1.addEventListener('timeupdate', () => {
            if (!isSyncing && Math.abs(video1.currentTime - video2.currentTime) > 0.5) {
                isSyncing = true;
                video2.currentTime = video1.currentTime;
                setTimeout(() => { isSyncing = false; }, 100);
            }
        });

        video2.addEventListener('timeupdate', () => {
            if (!isSyncing && Math.abs(video1.currentTime - video2.currentTime) > 0.5) {
                isSyncing = true;
                video1.currentTime = video2.currentTime;
                setTimeout(() => { isSyncing = false; }, 100);
            }
        });

        // è‡ªåŠ¨ä¿å­˜å½“å‰è¡Œï¼ˆæ— æç¤ºï¼Œé™é»˜ä¿å­˜ï¼‰
        function autoSaveCurrentRow() {
            const notes = document.getElementById('notes').value.trim();
            const differenceRadio = document.querySelector('input[name="difference"]:checked');
            const difference = differenceRadio ? differenceRadio.value : '';

            const url1Column = window.url1ColumnName || 'material_url';
            const url2Column = window.url2ColumnName || 'milvus_material_url';
            
            // åªæœ‰å½“æœ‰æ ‡è®°æˆ–å¤‡æ³¨æ—¶æ‰ä¿å­˜
            if (difference || notes) {
                savedData[currentIndex] = {
                    notes: notes,
                    difference: difference,
                    rowIndex: currentIndex,
                    [url1Column]: videoData[currentIndex][url1Column],
                    [url2Column]: videoData[currentIndex][url2Column]
                };
                
                // æ›´æ–°æ˜¾ç¤º
                updateCurrentRowInfo();
                
                // ä¿å­˜åˆ°localStorage
                saveToLocalStorage();
                
                console.log('è‡ªåŠ¨ä¿å­˜:', savedData[currentIndex]);
            } else {
                // å¦‚æœæ—¢æ²¡æœ‰æ ‡è®°ä¹Ÿæ²¡æœ‰å¤‡æ³¨ï¼Œåˆ é™¤ä¿å­˜çš„æ•°æ®
                delete savedData[currentIndex];
                updateCurrentRowInfo();
                saveToLocalStorage();
            }
        }

        // é˜²æŠ–å‡½æ•°
        let notesDebounceTimer = null;
        function debounceAutoSave() {
            clearTimeout(notesDebounceTimer);
            notesDebounceTimer = setTimeout(() => {
                autoSaveCurrentRow();
            }, 500); // 500msåä¿å­˜
        }

        // ä¸Šä¸€è¡Œ
        function previousRow() {
            if (currentIndex > 0) {
                // åˆ‡æ¢å‰å…ˆä¿å­˜å½“å‰è¡Œ
                clearTimeout(notesDebounceTimer);
                autoSaveCurrentRow();
                currentIndex--;
                loadRow(currentIndex);
                updateNavigationButtons();
            }
        }

        // ä¸‹ä¸€è¡Œ
        function nextRow() {
            if (currentIndex < videoData.length - 1) {
                // åˆ‡æ¢å‰å…ˆä¿å­˜å½“å‰è¡Œ
                clearTimeout(notesDebounceTimer);
                autoSaveCurrentRow();
                currentIndex++;
                loadRow(currentIndex);
                updateNavigationButtons();
            }
        }

        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateNavigationButtons() {
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === videoData.length - 1;
        }

        // æ›´æ–°å½“å‰è¡Œä¿¡æ¯
        function updateCurrentRowInfo() {
            const saved = savedData[currentIndex];
            const savedStatus = saved ? ` âœ“å·²ä¿å­˜(${saved.difference || 'æœªæ ‡è®°'})` : '';
            const savedCount = Object.keys(savedData).length;
            document.getElementById('currentRowInfo').textContent = 
                `ç¬¬ ${currentIndex + 1} è¡Œ / å…± ${videoData.length} è¡Œ${savedStatus} | å·²ä¿å­˜: ${savedCount} è¡Œ`;
        }

        // å¯¼å‡ºä¸ºExcel
        function exportToExcel() {
            const savedCount = Object.keys(savedData).length;
            if (savedCount === 0) {
                showStatus('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼Œè¯·å…ˆä¿å­˜ä¸€äº›è¡Œçš„æ•°æ®', 'error');
                return;
            }

            try {
                // åˆ›å»ºå¯¼å‡ºæ•°æ®ï¼Œç¡®ä¿å¤‡æ³¨å’Œæ˜¯å¦åŒè´¨åŒ–å­—æ®µæ­£ç¡®æ·»åŠ 
                const exportData = videoData.map((row, index) => {
                    const saved = savedData[index];
                    const result = { ...row };
                    
                    // æ·»åŠ å¤‡æ³¨å’Œæ˜¯å¦åŒè´¨åŒ–å­—æ®µ
                    result['å¤‡æ³¨'] = saved ? (saved.notes || '') : '';
                    result['æ˜¯å¦åŒè´¨åŒ–'] = saved ? (saved.difference || 'æœªæ ‡è®°') : 'æœªæ ‡è®°';
                    
                    return result;
                });

                console.log('å¯¼å‡ºæ•°æ®é¢„è§ˆï¼ˆå‰3è¡Œï¼‰:', exportData.slice(0, 3));
                console.log('æ€»è¡Œæ•°:', exportData.length);
                console.log('å·²ä¿å­˜çš„è¡Œæ•°:', savedCount);

                // åˆ›å»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'è§†é¢‘å¯¹æ¯”ç»“æœ');

                // å¯¼å‡ºæ–‡ä»¶
                const fileName = `è§†é¢‘å¯¹æ¯”ç»“æœ_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showStatus(`âœ… å·²æˆåŠŸå¯¼å‡º ${savedCount} è¡Œæ•°æ®åˆ° ${fileName}`, 'success');
                
                // æ˜¾ç¤ºä¿å­˜çš„è¡Œå·
                const savedRows = Object.keys(savedData).map(k => parseInt(k) + 1).join(', ');
                console.log('å·²ä¿å­˜çš„è¡Œå·:', savedRows);
            } catch (error) {
                console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
                showStatus('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const className = `status-${type}`;
            statusMessage.innerHTML = `<div class="status-message ${className}">${message}</div>`;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®è‡ªåŠ¨ä¿å­˜äº‹ä»¶ç›‘å¬å™¨å’ŒåŠ è½½ä¿å­˜çš„æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            // å°è¯•åŠ è½½ä¿å­˜çš„æ•°æ®
            if (!loadSavedData()) {
                showStatus('æ¬¢è¿ä½¿ç”¨ï¼è¯·ä¸Šä¼ Excelæ–‡ä»¶å¼€å§‹å¯¹æ¯”è§†é¢‘', 'info');
                setTimeout(() => {
                    statusMessage.innerHTML = '';
                }, 3000);
            }

            // ä¸ºæ‰€æœ‰"æ˜¯å¦åŒè´¨åŒ–"å•é€‰æŒ‰é’®æ·»åŠ changeäº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('input[name="difference"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    autoSaveCurrentRow();
                    showStatus(`å·²è‡ªåŠ¨ä¿å­˜ï¼š${this.value}`, 'success');
                    setTimeout(() => {
                        statusMessage.innerHTML = '';
                    }, 2000);
                });
            });

            // ä¸ºå¤‡æ³¨æ–‡æœ¬æ¡†æ·»åŠ inputäº‹ä»¶ç›‘å¬å™¨ï¼ˆé˜²æŠ–ï¼‰
            const notesTextarea = document.getElementById('notes');
            if (notesTextarea) {
                notesTextarea.addEventListener('input', function() {
                    debounceAutoSave();
                });
            }
        });
    </script>
</body>
</html>